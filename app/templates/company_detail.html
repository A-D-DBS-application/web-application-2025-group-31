{% extends "base.html" %}
{% block title %}{{ company.name }} | Baseline Report{% endblock %}

{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}

<div class="topbar">
  <div class="topbar-left">
    <h1>{{ company.name }}</h1>
    <p class="subtitle">Volledig automatisch gegenereerd baseline rapport.</p>
  </div>
</div>

<a href="{{ url_for('main.companies') }}" class="button mb-14 w-100 w-md-auto">← Terug naar bedrijven</a>

<div class="export-row mb-20 d-flex flex-wrap gap-2">
  <a class="button small action-btn" href="{{ url_for('main.export_company', company_id=company.company_id, format='json') }}">Export JSON</a>
  <a class="button small action-btn" href="{{ url_for('main.export_company', company_id=company.company_id, format='csv') }}">Export CSV</a>
  <a class="button small action-btn" href="{{ url_for('main.export_company', company_id=company.company_id, format='txt') }}">VC Memo</a>
  <a class="button small action-btn" href="{{ url_for('main.export_pdf', company_id=company.company_id) }}">Export PDF</a>
  <a class="button small action-btn" href="{{ url_for('main.export_slides', company_id=company.company_id) }}">Export Slides</a>
</div>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Bedrijfsinformatie</h2>
    <div class="card-meta">Website en identiteit</div>
  </div>
  <div class="card-body">
    <p><strong class="card-title">Website:</strong><br>
      {% if company.website_url %}
        <a class="subtitle" href="{{ company.website_url }}" target="_blank" rel="noopener noreferrer">{{ company.website_url }}</a>
      {% else %}
        <span class="tag">Geen website</span>
      {% endif %}
    </p>

    <p class="mt-15"><strong class="card-title">Sector:</strong><br>
      {% if company.sector %}
        <span class="tag tag-sector">{{ company.sector.name }}</span>
      {% else %}
        <span class="tag tag-unknown">Nog niet ingedeeld</span>
      {% endif %}
    </p>
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">AI Summary</h2>
    <div class="card-meta">Gegenereerd via scraping + AI</div>
  </div>
  <div class="card-body">
    <p class="card-title">{{ company.ai_summary or "Geen samenvatting beschikbaar" }}</p>
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Value Proposition</h2>
  </div>
  <div class="card-body">
    <p class="card-title">{{ company.value_proposition or "Onbekend" }}</p>
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Productbeschrijving</h2>
  </div>
  <div class="card-body">
    <p class="card-title">{{ company.product_description or "Geen productinformatie beschikbaar" }}</p>
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Doelgroep</h2>
  </div>
  <div class="card-body">
    <p class="card-title">{{ company.target_segment or "Onbekend segment" }}</p>
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Pricing</h2>
  </div>
  <div class="card-body">
    <p class="card-title">{{ company.pricing or "Geen pricing gevonden" }}</p>
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Belangrijkste Features</h2>
  </div>
  <div class="card-body">
    {% if company.key_features %}
      <ul class="soft-list">
        {% for f in company.key_features %}
          <li class="card-title">{{ f }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="subtitle">Geen features gedetecteerd.</p>
    {% endif %}
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Competitive Landscape</h2>
    <div class="card-meta">Automatisch gedetecteerde vergelijkbare bedrijven</div>
  </div>
  <div class="card-body">
    {% if company.competitors %}
      <ul class="soft-list">
        {% for c in company.competitors %}
          <li class="card-title">
            {% if c is mapping %}
              <strong>{{ c.name }}</strong>
              {% if c.description %}
                <div class="subtitle">{{ c.description }}</div>
              {% endif %}
            {% else %}
              {{ c }}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="subtitle">Geen concurrenten gevonden.</p>
    {% endif %}
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Business Fundamentals</h2>
    <div class="card-meta">Kernindicatoren gedetecteerd via AI</div>
  </div>
  <div class="card-body">
    <p class="subtitle"><strong class="card-title">Headquarters:</strong><br>{{ company.headquarters or "Onbekend" }}</p>

    <p class="subtitle"><strong class="card-title">Office Locations:</strong><br>
      {% if company.office_locations %}{{ company.office_locations }}{% else %}Niet beschikbaar{% endif %}
    </p>

    <p class="subtitle"><strong class="card-title">Team Size:</strong><br>{{ company.team_size or "Onbekend" }}</p>

    <p class="subtitle"><strong class="card-title">Total Funding:</strong><br>
      {% if company.funding %}
        {{ company.funding }}
      {% elif company.funding_history %}
        {{ company.funding_history }}
      {% else %}
        Onbekend
      {% endif %}
    </p>

    <p class="subtitle"><strong class="card-title">Funding History:</strong><br>{{ company.funding_history or "Geen gegevens" }}</p>
  </div>
</section>

<section class="card soft-shadow fade-in">
  <div class="card-header">
    <h2 class="card-title">Traction Signals</h2>
    <div class="card-meta">Gedetecteerde groei / activiteit</div>
  </div>
  <div class="card-body">
    <p class="card-title">{{ company.traction_signals or "Geen signalen" }}</p>
  </div>
</section>

<!-- ✅ SIMILARITY BLOCK (BOVEN HISTORISCHE TRENDS) -->
<section class="card soft-shadow fade-in mt-20">
  <div class="card-header">
    <h2 class="card-title">Vergelijkbare bedrijven</h2>
    <div class="card-meta">Top 5 op basis van baseline report velden</div>
  </div>

  <div class="card-body">
    {% if similar and similar|length > 0 %}
      <ul class="soft-list">
        {% for other, score in similar %}
          <li class="list-item-12">
            <strong class="card-title">{{ other.name }}</strong>

            <span class="badge-soft" style="margin-left: 10px;">
              Similarity: {{ score|round(2) }}%
            </span>

            <div class="card-meta mt-10">
              <a class="subtitle" href="{{ url_for('main.company_detail', company_id=other.company_id) }}">
                Bekijk baseline →
              </a>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="subtitle">Nog onvoldoende bedrijven om een vergelijking te maken.</p>
    {% endif %}
  </div>
</section>

<section class="card soft-shadow fade-in mt-20">
  <div class="card-header">
    <h2 class="card-title">Historische trends</h2>
    <div class="card-meta">AI-reconstructie aangevuld met live scrapes</div>
  </div>

  <div class="card-body">
    {% if pricing_labels or hiring_labels or review_distribution_values %}

      <div class="trend-grid">

        <div>
          <h3 class="card-title">Pricing evolution</h3>

          {% if pricing_labels|length < 2 %}
            <p class="subtitle">
              Nog onvoldoende data om trends te tonen (min. 2 meetpunten).
              We tonen voorlopig het huidige niveau.
            </p>
          {% endif %}

          <canvas id="priceChart"></canvas>
        </div>

        <div>
          <h3 class="card-title">Hiring activity</h3>

          {% if hiring_labels|length < 2 %}
            <p class="subtitle">Nog onvoldoende data om hiring-trends te tonen.</p>
          {% endif %}

          <canvas id="hiringChart"></canvas>
        </div>

        <div class="trend-grid-full">
          <h3 class="card-title">Review verdeling</h3>
          <canvas id="reviewChart"></canvas>
        </div>

      </div>

    {% else %}
      <p class="subtitle">
        Nog geen historiek beschikbaar. Scrape deze website meerdere keren om trends op te bouwen.
      </p>
    {% endif %}
  </div>
</section>

<section class="card soft-shadow fade-in mt-20">
  <div class="card-header">
    <h2 class="card-title">Strategische wijzigingen</h2>
    <div class="card-meta">Automatisch gedetecteerde veranderingen</div>
  </div>

  <div class="card-body">
    {% if events and events|length > 0 %}
      <ul class="soft-list">
        {% for e in events[:3] %}
          <li class="list-item-8">
            <strong class="card-title">{{ e.event_type }}</strong><br>
            <span class="card-title">{{ e.description }}</span><br>
            <span class="badge-soft">{{ e.detected_at.strftime('%Y-%m-%d') }}</span>
          </li>
        {% endfor %}
      </ul>

      {% if events|length > 3 %}
        <a href="{{ url_for('main.company_alerts', company_id=company.company_id) }}"
           class="button mt-10 w-100 w-md-auto">
          Bekijk alle wijzigingen →
        </a>
      {% endif %}
    {% else %}
      <p class="subtitle">Geen wijzigingen gedetecteerd.</p>
    {% endif %}
  </div>
</section>

{% endblock %}

{% block scripts %}
<script>
  // Data uit Flask
  const pricingLabels = {{ pricing_labels|tojson }};
  const pricingValues = {{ pricing_values|tojson }};

  const hiringLabels = {{ hiring_labels|tojson }};
  const hiringValues = {{ hiring_values|tojson }};

  const reviewDistribution = {{ review_distribution_values|tojson }};

  function destroyIfExists(canvas) {
    if (canvas && canvas._chartInstance) {
      canvas._chartInstance.destroy();
      canvas._chartInstance = null;
    }
  }

  // Pricing: tier chart (trapjes) + werkt ook met 1 datapunt
  function buildPricingTierChart(canvasId, labels, data) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || typeof Chart === "undefined") return;

    destroyIfExists(canvas);

    const tierLabels = {
      0: 'Onbekend',
      1: 'Gratis / Freemium',
      2: 'Lage prijsklasse',
      3: 'Midden segment',
      4: 'Hoge prijsklasse',
      5: 'Enterprise'
    };

    let L = Array.isArray(labels) ? labels.slice() : [];
    let V = Array.isArray(data) ? data.slice() : [];

    // min 2 punten zodat Chart.js altijd tekent
    if (L.length === 1) {
      L = [L[0], L[0]];
      V = [V[0], V[0]];
    }
    if (L.length === 0) return;

    const xLabels = L.map(d => String(d).slice(0, 10));
    const yValues = V.map(v => (v === null || v === undefined) ? null : Number(v));

    const chart = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: xLabels,
        datasets: [{
          data: yValues,
          stepped: true,
          tension: 0,
          fill: false,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.2,
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 6, maxRotation: 0 } },
          y: {
            min: 0,
            max: 5,
            ticks: {
              stepSize: 1,
              callback: (value) => tierLabels[value] ?? value
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => tierLabels[ctx.parsed.y] ?? `Tier ${ctx.parsed.y}`
            }
          }
        }
      }
    });

    canvas._chartInstance = chart;
  }

  // Hiring: gewone line chart (blijft simpel) + werkt ook met 1 datapunt
  function buildHiringChart(canvasId, labels, data, label) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || typeof Chart === "undefined") return;

    destroyIfExists(canvas);

    let L = Array.isArray(labels) ? labels.slice() : [];
    let V = Array.isArray(data) ? data.slice() : [];

    if (L.length === 1) {
      L = [L[0], L[0]];
      V = [V[0], V[0]];
    }
    if (L.length === 0) return;

    const xLabels = L.map(d => String(d).slice(0, 10));

    const chart = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: xLabels,
        datasets: [{
          label: label,
          data: V,
          tension: 0.25,
          fill: false,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.2,
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 6, maxRotation: 0 } },
          y: { beginAtZero: true }
        },
        plugins: { legend: { display: true } }
      }
    });

    canvas._chartInstance = chart;
  }

  // Reviews: bar chart (5 staven)
  function buildReviewBarChart() {
    const canvas = document.getElementById('reviewChart');
    if (!canvas || typeof Chart === "undefined") return;

    destroyIfExists(canvas);

    const chart = new Chart(canvas.getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['1★', '2★', '3★', '4★', '5★'],
        datasets: [{
          label: 'Aantal reviews',
          data: Array.isArray(reviewDistribution) ? reviewDistribution : [0,0,0,0,0],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.5,
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        },
        plugins: { legend: { display: false } }
      }
    });

    canvas._chartInstance = chart;
  }

  // Render charts (ook als er maar 1 datapunt is)
  buildPricingTierChart('priceChart', pricingLabels, pricingValues);
  buildHiringChart('hiringChart', hiringLabels, hiringValues, 'Team size');
  buildReviewBarChart();
</script>
{% endblock %}




